#!/usr/bin/env python

import subprocess
import sys


def get_running_instances():
    result = subprocess.run(
        ['aws', 'ec2', 'describe-instances',
         '--query', 'Reservations[*].Instances[*].[InstanceId]',
         '--filters', 'Name=instance-state-name,Values=running',
         '--output', 'text'],
        stdout=subprocess.PIPE,
        text=True)
    return sorted(result.stdout.split())


running_instances = get_running_instances()
if not running_instances:
    print('No running ec2 instances')
    sys.exit(0)

if len(running_instances) == 1:
    selected = running_instances[0]
else:
    fzf = subprocess.run(
        ['fzf'],
        stdout=subprocess.PIPE,
        input='\n'.join(running_instances),
        encoding='utf-8')

    selected = fzf.stdout.strip()

if selected:
    subprocess.run(['aws', 'ssm', 'start-session', '--target', selected])
